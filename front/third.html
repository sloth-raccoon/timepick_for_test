<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Common Available Time - TIMEPICK</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <!-- Custom CSS -->
    <style>
        body {
            min-height: 100vh;
            background-color: #f8f9fa;
            padding-top: 40px;
            font-family: Arial, sans-serif;
        }
        h1 {
            font-size: 36px;
            font-weight: bold;
            color: #67AD5B;
            margin-bottom: 20px;
        }
        .container {
            max-width: 900px;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .timezone-info {
            font-size: 14px;
            color: #343a40;
            margin-bottom: 10px;
            text-align: left;
        }
        .timezone-info a {
            color: #67AD5B;
            text-decoration: none;
        }
        .timezone-info a:hover {
            text-decoration: underline;
        }
        .time-table {
            /* width: 100%; */
            border-collapse: collapse;
            margin-top: 20px;
            margin-left: auto;
            margin-right: auto;
        }
        .time-table th {
            border: 1px solid #ddd;
            text-align: center;
            padding: 8px 4px;
            font-size: 14px;
            background-color: #f8f9fa;
            font-weight: bold;
            min-width: 70px; /* Adjusted width */
        }
        .time-table td.time-label-cell {
            border: 1px solid #ddd;
            border-right: 2px solid #aaa;
            text-align: right;
            padding: 2px 5px;
            font-size: 12px;
            font-weight: bold;
            vertical-align: top;
            background-color: #f8f9fa;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            width: 60px;
        }
        .time-table td.time-slot {
            border-left: 1px solid #eee;
            border-right: 1px solid #eee;
            border-top: none;
            border-bottom: none;
            height: 20px;
            padding: 0;
            background-color: white;
            cursor: pointer;
            transition: background-color 0.2s;
            min-width: 60px; /* Adjusted width */
            text-align: center;
        }
        .time-table tr.hour-start-row td.time-slot {
             border-top: 1px solid #ccc;
        }
        .time-table tr.half-hour-row td.time-slot {
            border-top: 1px dashed #ccc;
        }
        .time-table tbody tr:last-child td.time-slot {
             border-bottom: 1px solid #ccc;
        }
        .time-table td.time-slot:not(.selected):hover {
            background-color: #e9ecef;
        }
        .time-table td.available {
            background-color: #fff3cd;
        }
        .time-table td.time-slot.selected {
            background-color: #FFC107;
        }
        /* Combined button styles */
        .back-btn, .confirm-btn {
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 5px;
            margin-left: 10px;
        }
        .back-btn {
             background-color: #343a40;
        }
        .back-btn:hover {
            background-color: #23272b;
        }
        .confirm-btn {
            background-color: #67AD5B;
            /* margin-left: 0; */
        }
        .confirm-btn:hover {
            background-color: #56914c;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            text-align: left;
        }
        .text-start {
             text-align: left !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="title">Common Available Time!</h1>
            <!-- --- MODIFIED: Removed language button container --- -->
            <!-- Top-right Back button - remains unchanged -->
            <button class="btn back-btn" onclick="goBack()" id="back-btn">Back</button>
            <!-- --- END MODIFIED --- -->
        </div>

        <!-- Timezone Info -->
        <!-- --- MODIFIED: Removed "Change dates" link --- -->
        <div class="timezone-info">
            <span id="timezone-label">Asia/Taipei</span> |
            <a href="#" id="change-timezone">Change timezone</a>
        </div>
        <!-- --- END MODIFIED --- -->

        <!-- Time Table -->
        <table class="time-table" id="time-table">
            <thead>
                <tr>
                    <th></th>
                    <!-- Dates will be dynamically added -->
                </tr>
            </thead>
            <tbody>
                <!-- Time slots will be dynamically added -->
            </tbody>
        </table>

        <!-- Confirm Button -->
        <div class="text-start mt-4">
            <button class="btn confirm-btn" onclick="confirmSelection()" id="confirm-btn-bottom">Confirm</button>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <!-- Custom JavaScript -->
    <script>
        // --- MODIFIED: Removed isChinese and langData ---

        // Load data and display table on page load
        window.onload = function() {
            // --- MODIFIED: Removed language loading and updateLanguage call ---
            displayCommonTime();
        };

        // --- MODIFIED: Removed updateLanguage function ---

        // --- MODIFIED: Removed switchLanguage function ---

        // Go back function
        function goBack() {
            window.location.href = 'choose.html';
        }

        // Display selected time grid
        function displayCommonTime() {
            // 1. Get data from localStorage
            const scheduleData = JSON.parse(localStorage.getItem('schedule_data')) || {};
            const {
                timetableName = "Schedule", // Default name if not found
                startTime = "09:00",
                endTime = "17:00",
                selectedDates = []
            } = scheduleData;

            // Update Title - Use timetableName or a fixed default title
            // --- MODIFIED: Use fixed default title ---
            document.getElementById('title').textContent = timetableName || "Common Available Time!";
            // --- END MODIFIED ---

            // --- MODIFIED: Set fixed text for elements previously updated by updateLanguage ---
            document.getElementById('back-btn').textContent = "Back";
            document.getElementById('confirm-btn-bottom').textContent = "Confirm";
            document.getElementById('timezone-label').textContent = "Asia/Taipei"; // Example, keep as is or make dynamic based on actual timezone logic if added later
            document.getElementById('change-timezone').textContent = "Change timezone";
            // --- END MODIFIED ---


            // 2. Prepare Dates for Header (Sort them)
            const dates = selectedDates
                .map(dateStr => new Date(dateStr))
                .sort((a, b) => a - b);

            // 3. Generate Table Header (Dates)
            const tableHead = document.querySelector('#time-table thead tr');
            tableHead.innerHTML = '<th></th>';
            dates.forEach(date => {
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const dateString = `${date.getFullYear()}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const th = document.createElement('th');
                th.textContent = `${month}/${day}`; // Use fixed format
                th.dataset.date = dateString;
                tableHead.appendChild(th);
            });

            // 4. Generate Table Body (Time Slots)
            const tableBody = document.querySelector('#time-table tbody');
            tableBody.innerHTML = '';

            const startHour = parseInt(startTime.split(':')[0]);
            const endHour = parseInt(endTime.split(':')[0]);

            for (let hour = startHour; hour < endHour; hour++) {
                // Row for :00
                const row00 = document.createElement('tr');
                row00.classList.add('hour-start-row');

                const timeLabelCell = document.createElement('td');
                timeLabelCell.rowSpan = 2;
                timeLabelCell.classList.add('time-label-cell');
                let timeLabel;
                // Use fixed AM/PM format
                if (hour === 0) { timeLabel = '12 AM'; }
                else if (hour < 12) { timeLabel = `${hour} AM`; }
                else if (hour === 12) { timeLabel = '12 PM'; }
                else { timeLabel = `${hour - 12} PM`; }
                timeLabelCell.textContent = timeLabel;
                row00.appendChild(timeLabelCell);

                dates.forEach((date, index) => {
                    const cell = document.createElement('td');
                    cell.classList.add('time-slot');
                    const headerCell = tableHead.children[index + 1];
                    if (headerCell) {
                        const dateString = headerCell.dataset.date;
                        const timeString = `${String(hour).padStart(2, '0')}:00`;
                        cell.dataset.date = dateString;
                        cell.dataset.time = timeString;
                        cell.addEventListener('click', function() {
                            this.classList.toggle('selected');
                        });
                    } else {
                        console.error("Header cell not found for index:", index + 1);
                    }
                    row00.appendChild(cell);
                });
                tableBody.appendChild(row00);

                // Row for :30
                const row30 = document.createElement('tr');
                row30.classList.add('half-hour-row');

                dates.forEach((date, index) => {
                    const cell = document.createElement('td');
                    cell.classList.add('time-slot');
                     const headerCell = tableHead.children[index + 1];
                     if (headerCell) {
                        const dateString = headerCell.dataset.date;
                        const timeString = `${String(hour).padStart(2, '0')}:30`;
                        cell.dataset.date = dateString;
                        cell.dataset.time = timeString;
                        cell.addEventListener('click', function() {
                            this.classList.toggle('selected');
                        });
                    } else {
                        console.error("Header cell not found for index:", index + 1);
                    }
                    row30.appendChild(cell);
                });
                tableBody.appendChild(row30);
            }
        }

        // Function to handle confirming the selection
        function confirmSelection() {
            const selectedCells = document.querySelectorAll('#time-table td.time-slot.selected');
            const selectedTimes = [];
            selectedCells.forEach(cell => {
                selectedTimes.push({
                    date: cell.dataset.date,
                    time: cell.dataset.time,
                });
            });

            console.log("Selected Times:", selectedTimes);

            // Save data (example: localStorage)
            // localStorage.setItem('confirmed_times', JSON.stringify(selectedTimes));

            // Provide user feedback
            // --- MODIFIED: Use fixed alert text ---
            alert("Selected times confirmed and logged to console!");
            // --- END MODIFIED ---

            // Optional: Redirect
            // window.location.href = 'choose.html';
        }

    </script>
</body>
</html>
